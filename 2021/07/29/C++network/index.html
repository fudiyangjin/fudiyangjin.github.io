<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="好小好重">
<meta property="og:type" content="article">
<meta property="og:title" content="C++网络编程小重小难点">
<meta property="og:url" content="https://fudiyangjin.github.io/2021/07/29/C++network/index.html">
<meta property="og:site_name" content="fudiyangjin">
<meta property="og:description" content="好小好重">
<meta property="og:locale">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/1.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/TCP%E8%BF%9E%E6%8E%A5.jpg">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/2.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/3.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/4.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/5.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/6.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/7.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/select%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86.jpg">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/8.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/9.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/10.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/11.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/12.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/Select%E5%87%BD%E6%95%B0%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B.jpg">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/13.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/14.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/15.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/send%E5%92%8Crecv%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E.jpg">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/16.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/17.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/18.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/19.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/20.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/21.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%BA%8F%E5%8F%B7%E5%85%B3%E7%B3%BB.jpg">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/22.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/23.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/24.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/25.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/26.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/27.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/28.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/29.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/30.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/31.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/32.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/33.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/37.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/36.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/34.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/35.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/39.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/38.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/40.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/41.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/42.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/43.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/44.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/45.png">
<meta property="og:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/46.png">
<meta property="article:published_time" content="2021-07-28T16:27:58.000Z">
<meta property="article:modified_time" content="2021-07-29T15:51:57.534Z">
<meta property="article:author" content="巨鹏辉">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fudiyangjin.github.io/2021/07/29/C++network/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fudiyangjin.github.io/2021/07/29/C++network/"/>





  <title>C++网络编程小重小难点 | fudiyangjin</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fudiyangjin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fudiyangjin.github.io/2021/07/29/C++network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fudiyangjin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">C++网络编程小重小难点</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-29T00:27:58+08:00">
                2021-07-29
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2021-07-29T23:51:57+08:00">
                2021-07-29
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>好小好重</p>
<span id="more"></span>

<h1 id="Socket函数"><a href="#Socket函数" class="headerlink" title="Socket函数"></a>Socket函数</h1><p>大多数的SocketAPI都源于BSDSocket（Berkeley Sockets，伯克利套接字），因此这些Socket函数在不同的平台上都有相似的签名和参数。</p>
<ul>
<li><strong>在Linux查看Socket函数的帮助信息</strong></li>
</ul>
<p>通过man手册查看相应的函数签名和用法：</p>
<p><img src="./1.png" alt="1"></p>
<p><strong>一个函数说明一般包括以下几个部分：</strong></p>
<p>函数声明及相关数据结构所在的头文件。</p>
<p>函数签名，即该函数的参数类型、个数和返回值。</p>
<p>函数用法说明，可能包括一些注意事项。</p>
<p>函数返回值说明。</p>
<p>调用函数出错时可能得到的错误码值。</p>
<p>一些相关函数在man手册中的位置索引。</p>
<ul>
<li><strong>TCP网络通信的基本流程</strong></li>
</ul>
<p><strong>服务器一般通信流程：</strong></p>
<p>调用socket函数创建socket（监听socket）。</p>
<p>调用bind函数将socket绑定到某个IP和端口的二元组上。</p>
<p>调用listen函数开启监听。</p>
<p>当有客户端请求连接上来时，调用accept函数接收连接，产生一个新的socket（客户端socket）。</p>
<p>基于新产生的socket调用send或recv函数，开始与客户端进行数据交流。</p>
<p>通信结束后，调用close函数关闭监听socket。</p>
<p><strong>客户端一般通信流程：</strong></p>
<p>调用socket函数创建客户端socket。</p>
<p>调用connect函数尝试连接服务器。</p>
<p>连接成功后调用send或recv函数，开始于服务器进行数据交流。</p>
<p>通信结束后，调用close函数关闭监听socket。</p>
<p><img src="./TCP%E8%BF%9E%E6%8E%A5.jpg" alt="TCP连接"></p>
<p>服务端代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socket error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//初始化服务器地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htons</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error,&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动监听</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">		<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">		<span class="comment">//接受客户端连接</span></span><br><span class="line">		<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr *)&amp;clientaddr,</span><br><span class="line">			&amp;clientaddrlen);</span><br><span class="line">		<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">char</span> recvBuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			<span class="comment">//从客户端接受数据</span></span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">recv</span>(clientfd, recvBuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv data from client, data: &quot;</span> &lt;&lt; recvBuf</span><br><span class="line">					&lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">				<span class="comment">//将收到的数据原封不动地发给客户端</span></span><br><span class="line">				ret = <span class="built_in">send</span>(clientfd, recvBuf, <span class="built_in">strlen</span>(recvBuf), <span class="number">0</span>);</span><br><span class="line">				<span class="keyword">if</span> (ret != <span class="built_in">strlen</span>(recvBuf))</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;send data error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;send data to client successfully, data:&quot;</span></span><br><span class="line">					&lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv data error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">close</span>(clientfd);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭监听socket</span></span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接服务器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SEVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//向服务器发送数据</span></span><br><span class="line">	<span class="keyword">int</span> ret = <span class="built_in">send</span>(clientfd, SEND_DATA, <span class="built_in">strlen</span>(SEND_DATA), <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="built_in">strlen</span>(SEND_DATA))</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;send data error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;send data successfully, data:&quot;</span> &lt;&lt; SEND_DATA &lt;&lt; std::endl;</span><br><span class="line">	<span class="comment">//服务器收取数据</span></span><br><span class="line">	<span class="keyword">char</span> recvBuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ret = <span class="built_in">recv</span>(clientfd, recvBuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv data successfully, data: &quot;</span> &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv data error, data: &quot;</span> &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后先启动服务端再启动客户端</p>
<p>客户端输出：</p>
<p><img src="./2.png" alt="2"></p>
<p>服务端输出：</p>
<p><img src="./3.png" alt="3"></p>
<h2 id="跨平台网络通信库的socket用法"><a href="#跨平台网络通信库的socket用法" class="headerlink" title="跨平台网络通信库的socket用法"></a>跨平台网络通信库的socket用法</h2><h3 id="socket数据类型"><a href="#socket数据类型" class="headerlink" title="socket数据类型"></a><strong>socket数据类型</strong></h3><p>Windos上，socket对象的类型是SOCKET。Linux上，socket对象类型是int。所以很多网络库中使用了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></span><br><span class="line"><span class="keyword">typedef</span> SOCKET   SOCKET_TYPE</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span>      SOCKET_TYPE</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>这样就可以同时在Windows和Linux上使用SOCKET_TYPE类型代表socket了。</p>
<p>无论是Windows还是Linux在socket函数调用失败时均会返回-1。Windows为这种情形定义了一个INCALID_HANDLE_VALU宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INVALID_HANDLE_VALUE (-1)</span></span><br></pre></td></tr></table></figure>

<p>在Linux上不存在INVALID_HANDLE_VALUE宏，可以用上述语句定义。</p>
<h3 id="在WINDOWS上调用socket函数"><a href="#在WINDOWS上调用socket函数" class="headerlink" title="在WINDOWS上调用socket函数"></a><strong>在WINDOWS上调用socket函数</strong></h3><p>Linux可以直接使用socket函数</p>
<p>//TODO Windows的之后再补</p>
<h1 id="bind函数重难点分析"><a href="#bind函数重难点分析" class="headerlink" title="bind函数重难点分析"></a>bind函数重难点分析</h1><h2 id="bind函数如何选择绑定地址"><a href="#bind函数如何选择绑定地址" class="headerlink" title="bind函数如何选择绑定地址"></a><strong>bind函数如何选择绑定地址</strong></h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htons</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error,&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>INADDR_ANY是一个宏，底层的协议栈服务会自动选择一个合适的IP地址，因此INADDR_ANY其实相当于0.0.0.0。在一台机器上开发服务器程序时有多个IP地址可选：外网IP、局域网IP、本地回环地址127.0.0.1。</p>
<h2 id="bind函数端口号"><a href="#bind函数端口号" class="headerlink" title="bind函数端口号"></a>bind函数端口号</h2><p>TCP中，一般服务端的端口号是固定的，而客户端的端口号是由操作系统自由分配的。端口号是一个C short类型的值，其范围为0~65535。</p>
<p><strong>如果客户端不绑定端口</strong></p>
<p>修改后的服务端代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socket error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//初始化服务器地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htons</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error,&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动监听</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//记录所有客户端连接的容器</span></span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; clientfds;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">		<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">		<span class="comment">//接受客户端连接</span></span><br><span class="line">		<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr *)&amp;clientaddr,</span><br><span class="line">			&amp;clientaddrlen);</span><br><span class="line">		<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">char</span> recvBuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			<span class="comment">//从客户端接受数据</span></span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">recv</span>(clientfd, recvBuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv data from client, data: &quot;</span> &lt;&lt; recvBuf</span><br><span class="line">					&lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">				<span class="comment">//将收到的数据原封不动地发给客户端</span></span><br><span class="line">				ret = <span class="built_in">send</span>(clientfd, recvBuf, <span class="built_in">strlen</span>(recvBuf), <span class="number">0</span>);</span><br><span class="line">				<span class="keyword">if</span> (ret != <span class="built_in">strlen</span>(recvBuf))</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;send data error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;send data to client successfully, data:&quot;</span></span><br><span class="line">					&lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv data error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//close(clientfd);</span></span><br><span class="line">			clientfds.<span class="built_in">push_back</span>(clientfd);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭监听socket</span></span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加了个vector记录客户端连接，客户端修改代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接服务器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SEVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//向服务器发送数据</span></span><br><span class="line">	<span class="keyword">int</span> ret = <span class="built_in">send</span>(clientfd, SEND_DATA, <span class="built_in">strlen</span>(SEND_DATA), <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="built_in">strlen</span>(SEND_DATA))</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;send data error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;send data successfully, data:&quot;</span> &lt;&lt; SEND_DATA &lt;&lt; std::endl;</span><br><span class="line">	<span class="comment">//服务器收取数据</span></span><br><span class="line">	<span class="keyword">char</span> recvBuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ret = <span class="built_in">recv</span>(clientfd, recvBuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv data successfully, data: &quot;</span> &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv data error, data: &quot;</span> &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加了个while循环以防客户端退出，先启动服务端，再启动3个客户端，并利用lsof查看当前机器的TCP连接信息。</p>
<p><img src="./4.png" alt="4"></p>
<p><strong>客户端绑定0号端口</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接服务器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(clientfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">    serveraddr.sin_port = <span class="built_in">htons</span>(SEVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//向服务器发送数据</span></span><br><span class="line">	<span class="keyword">int</span> ret = <span class="built_in">send</span>(clientfd, SEND_DATA, <span class="built_in">strlen</span>(SEND_DATA), <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="built_in">strlen</span>(SEND_DATA))</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;send data error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;send data successfully, data:&quot;</span> &lt;&lt; SEND_DATA &lt;&lt; std::endl;</span><br><span class="line">	<span class="comment">//服务器收取数据</span></span><br><span class="line">	<span class="keyword">char</span> recvBuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ret = <span class="built_in">recv</span>(clientfd, recvBuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv data successfully, data: &quot;</span> &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv data error, data: &quot;</span> &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./5.png" alt="5"></p>
<p>端口号仍然是自由分配的，0号端口绑定和不绑效果一样。</p>
<p><strong>客户端绑定一个固定端口</strong></p>
<p>将客户端的socket绑定到20000端口上</p>
<p><img src="./6.png" alt="6"></p>
<p>客户端确实被使用20000端口连接到server，这时再启动一个客户端进程</p>
<p><img src="./7.png" alt="7"></p>
<p>端口已被占用，新启动的客户端进程会由于调用bind函数出错而退出。</p>
<h1 id="select函数的用法和原理"><a href="#select函数的用法和原理" class="headerlink" title="select函数的用法和原理"></a>select函数的用法和原理</h1><h2 id="Linux上的select函数"><a href="#Linux上的select函数" class="headerlink" title="Linux上的select函数"></a><strong>Linux上的select函数</strong></h2><p>select函数用于检测在一组socket中是否有事件就绪。一般分三类：</p>
<p>1） <strong>读事件就绪</strong></p>
<ul>
<li><p>在socket内核中，接受缓存区中的字节数大于或等于低水位标记SO_RCVLOWAT，</p>
<p>此时调用recv或read函数可以无限阻塞地读该文件描述符，并且返回值大于0。</p>
</li>
<li><p>TCP连接的对端关闭连接，此时本端调用recv或read函数对socket进行读操作mrecv或read函数会返回0值。</p>
</li>
<li><p>在监听socket上有新的连接请求。</p>
</li>
<li><p>在socket上有未处理的错误</p>
</li>
</ul>
<p>2） <strong>写事件就绪</strong></p>
<ul>
<li>在socket内核中，发送缓冲区中可用字节数（发送缓冲区的空闲位置大小）大于或等于低于水位标记SO_SNDLOWAT时，可用无线组赛地写，并且返回值大于0.</li>
<li>socket的写操作被关闭（调用了close或shutdown函数）时，对一个写操作被关闭的socket进行写操作，会触发SIGPIPE信号。</li>
<li>socket使用非阻塞connect连接成功或失败时</li>
</ul>
<p>3） <strong>异常事件就绪</strong></p>
<p>在socket上受到带外数据，函数签名如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> nfds,</span></span></span><br><span class="line"><span class="params"><span class="function">				fd_set *readfds,</span></span></span><br><span class="line"><span class="params"><span class="function">				fd_set *writefds,</span></span></span><br><span class="line"><span class="params"><span class="function">				fd_set *exceptfds,</span></span></span><br><span class="line"><span class="params"><span class="function">				struct timeval *timeout)</span></span>;</span><br><span class="line"><span class="comment">//nfds:Linux，将这个参数的值设置为所有需要使用select函数检测事件的fd中的最大值加1</span></span><br><span class="line"><span class="comment">//readfds，需要监听可读事件的fd集合。</span></span><br><span class="line"><span class="comment">//writefds，需要监听可写事件的fd集合。</span></span><br><span class="line"><span class="comment">//exceptfds，需要监听异常事件的fd集合。</span></span><br><span class="line"><span class="comment">//timeou，超时事件，规定时间内检测这些fd事件，超过时间后，select函数立即返回，结构体定义如下：</span></span><br><span class="line"><span class="comment">//struct timeval</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//  long tv_sec;</span></span><br><span class="line"><span class="comment">//  long tv_usec;</span></span><br><span class="line"><span class="comment">//&#125;;</span></span><br><span class="line"><span class="comment">//参数readfds、writefds和exceptfds的类型都是fd_set，结构体规定如下：</span></span><br><span class="line"><span class="comment">//fd_set字段必须是一个long型数组</span></span><br><span class="line"><span class="comment">//typedef long int __fd_mask;</span></span><br><span class="line"><span class="comment">//某些版本的&lt;linux/posix_types.h&gt;文件定义了如下宏</span></span><br><span class="line"><span class="comment">//#define __NFDBITS    (8 * (int) sizeof (__fd_mask))</span></span><br><span class="line"><span class="comment">//$define __FD_ELT(d)     ((d) / __NFDBITS)</span></span><br><span class="line"><span class="comment">//#define __FD_MASK(d)    ((__fd_mask) 1 &lt;&lt; ((d) % __NFDBITS))</span></span><br><span class="line"><span class="comment">//typedef struct</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//  __FD_SETSIZE = 1024</span></span><br><span class="line"><span class="comment">//  __NFDBITS = 64</span></span><br><span class="line"><span class="comment">//  __fd_mask __fds_bits [__FD_SETSIZE / __NFDBITS];</span></span><br><span class="line"><span class="comment">//#define __FDB_BITS(set)  ((set)-&gt;__fds_bits)</span></span><br><span class="line"><span class="comment">//&#125;fd_set;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//fd_set结构体中文件描述符的最大数量，1024</span></span><br><span class="line"><span class="comment">//#define FD_SETSIZE    __FD_SETSIZE</span></span><br></pre></td></tr></table></figure>

<p>FD_SET宏本质上是在一个有1024给连续bit(共计64字节)的内存的某个bit上设置一个标志。如果需要在fd_set中删除一个fd，即将对应的bit置0，则可以使用宏FD_CLR：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd, fd_set *set)</span></span>;</span><br></pre></td></tr></table></figure>

<p>如果需要将fd_set中所有的fd都清掉，即将所有bit都置0，则可以使用FD_ZERO：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *set)</span></span>;</span><br></pre></td></tr></table></figure>

<p>当select函数返回时，使用FD_ISSET宏判断在某个fd中是否有我们关心的事件，定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *set)</span></span>;</span><br></pre></td></tr></table></figure>

<p>FD_ISSET宏在本质上就是检测对应的bit是否置位</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __FD_ISSET(d, set)</span></span><br><span class="line">		((__FDS_BITS  (set) [__FD_ELT (d)] &amp; __FD_MASK (d)) != <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>示意图如下：</p>
<p><img src="./select%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86.jpg" alt="select函数调用原理"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INVALID_FD -1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建socket</span></span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == INVALID_FD)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create socket error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//初始化服务器地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3001</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动监听</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//存客户端socket</span></span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; clientfds;</span><br><span class="line">	<span class="keyword">int</span> maxfd;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		fd_set readset;</span><br><span class="line">		<span class="built_in">FD_ZERO</span>(&amp;readset);</span><br><span class="line">		<span class="comment">//将监听socket加入待检测的可读事件中</span></span><br><span class="line">		<span class="built_in">FD_SET</span>(listenfd, &amp;readset);</span><br><span class="line">		maxfd = listenfd;</span><br><span class="line">		<span class="comment">//将客户端fd加入待检测的可读事件中</span></span><br><span class="line">		<span class="keyword">int</span> clientfdslength = clientfds.<span class="built_in">size</span>();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientfdslength; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (clientfds[i] != INVALID_FD)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">FD_SET</span>(clientfds[i], &amp;readset);</span><br><span class="line">				<span class="keyword">if</span> (maxfd &lt; clientfds[i])</span><br><span class="line">					maxfd = clientfds[i];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		timeval tm;</span><br><span class="line">		tm.tv_sec = <span class="number">1</span>;</span><br><span class="line">		tm.tv_usec = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//只检测可读事件，不检测可写和异常事件</span></span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;readset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tm);</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno != EINTR)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//防止超时</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//检测到某个socket有事件</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(listenfd, &amp;readset))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//监听socket的可读事件，表明有新的连接到来</span></span><br><span class="line">				struct  sockaddr_in clientaddr;</span><br><span class="line">				<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">				<span class="comment">//接受客户端连接</span></span><br><span class="line">				<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr *)&amp;clientaddr, &amp;clientaddrlen);</span><br><span class="line">				<span class="keyword">if</span> (clientfd == INVALID_FD)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;accept a client connection, fd: &quot;</span> &lt;&lt; clientfd &lt;&lt; std::endl;</span><br><span class="line">				clientfds.<span class="built_in">push_back</span>(clientfd);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//假设发来的数据长度不超过63个字符</span></span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">64</span>];</span><br><span class="line">				<span class="keyword">int</span> clientfdslength = clientfds.<span class="built_in">size</span>();</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientfdslength; ++i)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (clientfds[i] != INVALID_FD &amp;&amp; <span class="built_in">FD_ISSET</span>(clientfds[i], &amp;readset))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">						<span class="comment">//非监听socket，接受数据</span></span><br><span class="line">						<span class="keyword">int</span> length = <span class="built_in">recv</span>(clientfds[i], recvbuf, <span class="number">64</span>, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">if</span> (length &lt;= <span class="number">0</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">//接收数据出错</span></span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;recv data error, clientfd: &quot;</span> &lt;&lt; clientfds[i] &lt;&lt; std::endl;</span><br><span class="line">							<span class="built_in">close</span>(clientfds[i]);</span><br><span class="line">							clientfds[i] = INVALID_FD;</span><br><span class="line">							<span class="keyword">continue</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						std::cout &lt;&lt; <span class="string">&quot;clientfd: &quot;</span> &lt;&lt; clientfds[i] &lt;&lt; <span class="string">&quot;, recv data: &quot;</span> &lt;&lt; recvbuf &lt;&lt; std::endl;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭所有客户端socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfdslength = clientfds.<span class="built_in">size</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientfdslength; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientfds[i] != INVALID_FD)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">close</span>(clientfds[i]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译并运行</p>
<p><img src="./8.png" alt="8"></p>
<p>利用Linux的nc指令模拟两个客户端。</p>
<p>命令行窗口1使用nc命令模拟客户端1连接成功后发送hello123：</p>
<p><img src="./9.png" alt="9"></p>
<p>命令行窗口2使用nc命令模拟客户端2连接成功后发送helloworld：</p>
<p><img src="./10.png" alt="10"></p>
<p>服务端输出如下：</p>
<p><img src="./11.png" alt="11"></p>
<p>nc发送的数据是按换行符来区分的，每个数据包默认的换行符都以\n结束</p>
<p>客户端断开连接后，服务端输出如下：</p>
<p><img src="./12.png" alt="12"></p>
<p>断开连接后，服务端的select函数对各个客户端fd检测时，仍然会触发可读事件，此时对这些fd调用recv函数会返回0，因此当recv函数返回0后表明对端关闭了连接。</p>
<p>select同样适合客户端网络通信，只需要用select检测连接socket。如果连接socket有可读事件，则调用recv函数接收数据。</p>
<p><img src="./Select%E5%87%BD%E6%95%B0%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B.jpg" alt="Select函数使用示例"></p>
<h2 id="几点说明："><a href="#几点说明：" class="headerlink" title="几点说明："></a><strong>几点说明：</strong></h2><ul>
<li>select函数在调用前后可能会修改readfds、writefds和excefds这三个集合中的内容，所以如果想在下次调用FD_SET将需要检测事件的fd重新添加到fd_set中。</li>
<li>select函数也会修改timeval结构体的值，如果想复用这个变量，则必须给timeval变量重新设置值。以之前的代码为例，调用select后，变量tv的值会被修改（Linux会改，Windows不会）。</li>
<li>select函数的timeval结构体中的tv_sec和tv_usec如果都被设置为0，即检测事件的总时间被设置为0，则其行为是select检测相关集合中的fd，如果没有需要的事件，则立即返回。代码验证如下：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_ADDRESS <span class="meta-string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_PORT 3001</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SERVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		fd_set readset;</span><br><span class="line">		<span class="built_in">FD_ZERO</span>(&amp;readset);</span><br><span class="line">		<span class="comment">//将监听socket加入待检测的可读事件中</span></span><br><span class="line">		<span class="built_in">FD_SET</span>(clientfd, &amp;readset);</span><br><span class="line">		timeval tm;</span><br><span class="line">		tm.tv_sec = <span class="number">0</span>;</span><br><span class="line">		tm.tv_usec = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//暂且只检测可读事件，不可检测可写和异常事件</span></span><br><span class="line">		ret = <span class="built_in">select</span>(clientfd + <span class="number">1</span>, &amp;readset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tm);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;tm.tv_sec: &quot;</span> &lt;&lt; tm.tv_sec &lt;&lt; <span class="string">&quot;, tm.tv_usec: &quot;</span></span><br><span class="line">			&lt;&lt; tm.tv_usec &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//除了被信号中断的情况，对其他情况都出错</span></span><br><span class="line">			<span class="keyword">if</span> (errno != EINTR)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//select函数超时</span></span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;no event in specific time interval.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(clientfd, &amp;readset))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//检测到可读事件</span></span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">32</span>];</span><br><span class="line">				<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">				<span class="keyword">int</span> n = <span class="built_in">recv</span>(clientfd, recvbuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">				<span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//除了被信号中断的情况，对其他情况都出错</span></span><br><span class="line">					<span class="keyword">if</span> (errno != EINTR)</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;recv data: &quot;</span> &lt;&lt; recvbuf &lt;&lt; std::endl;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;other socket event. &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./13.png" alt="13"></p>
<p>设置成0之后select检测clientfd，立即返回。</p>
<ul>
<li><p>将select函数的timeval参数设置NULL，则select会一直阻塞下去，直到我们需要的事件触发。修改上一份代码，将timeval相关注释，并将select函数最后一位参数置NULL</p>
<p><img src="./14.png" alt="14"></p>
<p><img src="./15.png" alt="15"></p>
<p>利用gdb调试程序，看程序卡在了哪个位置，run命令让程序跑起来后，利用Ctrl+C中断程序后使用backtrace命令查看当前程序调用堆栈，发现阻塞在select调用处。接着在服务端向客户端发送一个hello数据。</p>
<p>客户端收到数据后，select函数满足条件，立即返回，将数据输出后继续进行下一轮select检测。利用Ctrl+C中断程序，发现程序又阻塞在select调用处。</p>
<p>服务端再向客户端发送word数据，select函数再次返回打印出来后，又进行下一轮select检测，并在select处阻塞。</p>
</li>
<li><p>Linux上，select函数的第1个参数必须被设置为需要检测事件所有fd中的最大值加1。</p>
</li>
</ul>
<h2 id="Linux-select函数的缺点："><a href="#Linux-select函数的缺点：" class="headerlink" title="Linux select函数的缺点："></a><strong>Linux select函数的缺点：</strong></h2><ul>
<li>每次调用select函数，都需要把fd集合从用户态复制到内核态，这个开销在fd较多时会很大，同时每次调用select函数都需要在内核中遍历传递进来的所有fd，这个开销在fd较多时也很大。</li>
<li>单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024，可以通过先修改宏定义然后重新编译内核来调整这一限制，但这样非常麻烦而且效率低下。</li>
<li>select函数在每次调用之前都要对传入的参数进行重新设定。</li>
<li>在Linux上，select函数的实现原理是其底层使用了poll函数。</li>
</ul>
<h1 id="socket的阻塞模式和非阻塞模式"><a href="#socket的阻塞模式和非阻塞模式" class="headerlink" title="socket的阻塞模式和非阻塞模式"></a>socket的阻塞模式和非阻塞模式</h1><p>阻塞模式指当某个函数执行成功的条件当前不满足时，该函数会阻塞当前执行线程，程序执行流在超时时间到达或执行成功的条件满足后恢复继续执行。非阻塞模式则恰恰相反，即使某个函数执行成功的条件当前不能满足，该函数也不会阻塞当前执行线程，而是立即返回，继续执行程序流。</p>
<h2 id="如何将socket设置为非阻塞模式"><a href="#如何将socket设置为非阻塞模式" class="headerlink" title="如何将socket设置为非阻塞模式"></a>如何将socket设置为非阻塞模式</h2><p>无论是Windows还是Linux，默认创建的socket都是阻塞模式的。</p>
<p>在Linux上，我们可以使用fcntl函数或ioctl函数给创建的socket增加O_NONBLOCK标志来将socket设置为非阻塞模式。示例代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line"><span class="built_in">fcntl</span>(sockfd, F_SETFL, newSocketFlag);</span><br></pre></td></tr></table></figure>

<p>ioctl函数与fcntl函数的使用方式基本一致</p>
<p>Linux上socket函数也可以直接在创建时将socket设置为非阻塞模式，socket函数签名如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>

<p>给type参数增加一个SOCK_NONBLOCK标志即可，例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> s = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM | SOCK_NONBLOCK, IPPROTO_TCP);</span><br></pre></td></tr></table></figure>

<p>在Linux上利用accept函数返回的代表与客户端通信的socket也提供了一个扩展函数accept4，直接将accept函数返回的socket设置为非阻塞的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr * addr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept4</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *addr, <span class="keyword">socklen_t</span> *addrlen, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>

<p>只要将accept4函数的最后一个参数flags设置为SOCK_NONBLOCK即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">socklen_t</span> addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line"><span class="keyword">int</span> clientfd = <span class="built_in">accept4</span>(listenfd, &amp;clientaddr, &amp;addrlen, SOCK_NONBLOCK);</span><br><span class="line"><span class="keyword">socklen_t</span> addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line"><span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, &amp;clientaddr, &amp;addrlen);</span><br><span class="line"><span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="send和recv函数在阻塞和非阻塞模式下的表现"><a href="#send和recv函数在阻塞和非阻塞模式下的表现" class="headerlink" title="send和recv函数在阻塞和非阻塞模式下的表现"></a>send和recv函数在阻塞和非阻塞模式下的表现</h2><p>send是将应用层发送缓冲区的数据拷贝到内核缓冲区中，至于数据什么时候会从网卡缓冲区中真正地发到网络中，要根据TCP/IP协议栈的行为来确定。如果socket设置了TCP_NODELAY选项（禁用nagel算法），存放到内核缓存区的数据就会被立即发出去，反之，一次放入内核缓冲区的数据包如果太小，则系统会在多个小的数据包凑成一个足够大的数据包后才会将数据发出去。</p>
<p>recv函数是将内核缓冲区中的数据拷贝到应用程序的缓冲区中，拷贝完成后会将内核缓冲区中的该部分数据移除。</p>
<p><img src="./send%E5%92%8Crecv%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E.jpg" alt="send和recv阻塞和非阻塞"></p>
<p>当socket是阻塞模式时，继续调用send/recv函数，程序会阻塞在send/recv调用处</p>
<p>当socket是非阻塞模式时，继续调用send/recv函数，send/recv函数不会阻塞程序执行流，而是立即出错并返回，并且会得到一个相关的错误码。</p>
<h3 id="socket阻塞模式下send函数的表现"><a href="#socket阻塞模式下send函数的表现" class="headerlink" title="socket阻塞模式下send函数的表现"></a><strong>socket阻塞模式下send函数的表现</strong></h3><p>服务端代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socket error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//初始化服务器地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htons</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error,&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动监听</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">		<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">		<span class="comment">//接受客户端连接</span></span><br><span class="line">		<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr *)&amp;clientaddr,</span><br><span class="line">			&amp;clientaddrlen);</span><br><span class="line">		<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;accept a client connection &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接服务器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SEVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">send</span>(clientfd, SEND_DATA, <span class="built_in">strlen</span>(SEND_DATA), <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret != <span class="built_in">strlen</span>(SEND_DATA))</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;send data error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			count++;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;send data succesfully, count = &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译：</p>
<p><img src="./16.png" alt="16"></p>
<p>运行服务端，利用gdb启动客户端。</p>
<p>先启动服务器端，再用gdb启动客户端，利用run命令运行客户端：</p>
<p><img src="./17.png" alt="17"></p>
<p>发现程序卡在了某一阶段不再运行，此时利用Ctrl+C中断程序，并利用backtrace命令查看此时的调用堆栈。</p>
<p><img src="./18.png" alt="18"></p>
<p>发现程序阻塞在send函数调用处，一端一直发送数据，对端应用层一直不接受数据（接受慢于发送速度），则两端的内核缓冲区（TCP窗口）很快就会被填满，导致发送端调用send函数被阻塞。socket阻塞模式下，send函数在TCP窗口太小时会阻塞send函数所在线程的执行。</p>
<p>编译安装Linux的tcpdump工具，用来查看TCP窗口大小的动态变化。</p>
<p><img src="./19.png" alt="19"></p>
<p>启动服务器客户端，当客户端不再输出时抓包结果如下：</p>
<p><img src="./20.png" alt="20"></p>
<p>抓到的前三个数据包是TCP为建立连接而发起的：</p>
<p><img src="./21.png" alt="21"></p>
<p><img src="./%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%BA%8F%E5%8F%B7%E5%85%B3%E7%B3%BB.jpg" alt="三次握手序号关系"></p>
<p>可以发现每次应答数据包中都会带上当前可用TCP窗口大小，即win字段大小的变化，由于TCP流量控制和拥塞控制机制的存在，可以发现length会在短期内慢慢增加，随着缓冲区积压数据越来越多，会慢慢变为0。</p>
<p>实验中还可以发现，在对端已经无法接受数据后，客户端还能发送一段时间的数据才会出现“send data error”字段：</p>
<p><img src="./22.png" alt="22"></p>
<p>此时数据不是发送给对端，而是因为send函数实质是向内核缓冲区拷贝数据，所以数据会逐渐填满到本段内核发送缓冲区。</p>
<h3 id="socket非阻塞模式下send函数的表现"><a href="#socket非阻塞模式下send函数的表现" class="headerlink" title="socket非阻塞模式下send函数的表现"></a>socket非阻塞模式下send函数的表现</h3><p>服务端代码不变，修改客户端中的socket为非阻塞：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接服务器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SEVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接成功以后将clientfd设置为非阻塞模式</span></span><br><span class="line">	<span class="comment">//不能在连接时创建，会影响到connect函数的行为</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set socket to nonblock error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">send</span>(clientfd, SEND_DATA, <span class="built_in">strlen</span>(SEND_DATA), <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//非阻塞模式下，send函数由于TCP窗口发不出去数据，错误码是EWOULDBLOCK</span></span><br><span class="line">			<span class="keyword">if</span> (errno == EWOULDBLOCK)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;send data error as TCP Window size is too small &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;sending data interrupted by signal &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;send data error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//ret为0相当于对端关闭连接</span></span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;send data error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="built_in">close</span>(clientfd);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			count++;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;send data successfully, count = &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./23.png" alt="23"></p>
<p><img src="./24.png" alt="24"></p>
<p>正常发送一段时间后，对端和本端TCP窗口已满，数据发不出去，但send函数不会阻塞，而是立即返回，返回值为-1，错误码为EWOULDBLOCK</p>
<h3 id="socket阻塞模式下recv函数的表现"><a href="#socket阻塞模式下recv函数的表现" class="headerlink" title="socket阻塞模式下recv函数的表现"></a>socket阻塞模式下recv函数的表现</h3><p>服务端代码不变，修改客户端代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接服务器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SEVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="built_in">recv</span>(clientfd, recvbuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv successfully&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;recv data error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./25.png" alt="25"></p>
<p>编译并用gdb调试，发现程序既没有输出recv函数调用成功的信息，也没有recv函数调用失败的信息，利用backtrace命令查看此时调用堆栈发现，阻塞在recv函数处。得出结论，如果服务器不向客户端发送数据，则此时客户端调用recv函数的执行流会阻塞在recv函数调用处。</p>
<h3 id="socket非阻塞模式下recv函数的表现"><a href="#socket非阻塞模式下recv函数的表现" class="headerlink" title="socket非阻塞模式下recv函数的表现"></a>socket非阻塞模式下recv函数的表现</h3><p>服务端不变，修改客户端为非阻塞模式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEVER_PORT = <span class="number">3001</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建一个socket</span></span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接服务器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SEVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//连接成功以后，再将clientfd设置为非阻塞模式</span></span><br><span class="line">	<span class="comment">//不能在创建时就设置，这样会影响到connect函数的行为</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set socket to nonblock error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//直接调用recv函数，程序会阻塞在recv函数调用处</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> recvbuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(clientfd, recvbuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;recv successfully&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//ret为0相当于对端关闭连接</span></span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;peer close the socket&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EWOULDBLOCK)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;There is no data available now &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//如果被信号中断，则继续重试recv函数</span></span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv data interrupted by signal &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./26.png" alt="26"></p>
<p>recv函数在无数据可读的情况下并不会阻塞程序执行流，在非阻塞模式下，如果当前无数据可读，则recv函数将立即返回，返回值为-1，错误码为EWOULDBLOCK。</p>
<h2 id="非阻塞模式下send和recv函数返回值总结"><a href="#非阻塞模式下send和recv函数返回值总结" class="headerlink" title="非阻塞模式下send和recv函数返回值总结"></a>非阻塞模式下send和recv函数返回值总结</h2><table>
<thead>
<tr>
<th>返回值n</th>
<th>返回值的含义</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td>大于0</td>
<td>成功发送(send)或接收(recv)n字节</td>
</tr>
<tr>
<td>0</td>
<td>对端关闭连接</td>
</tr>
<tr>
<td>小于0（-1）</td>
<td>出错、被信号中断、对端TCP窗口太小导致数据发送不出去或者当前网卡缓冲区已无数据可接收</td>
</tr>
</tbody></table>
<ul>
<li><strong>返回值大于0</strong></li>
</ul>
<p>当send和recv函数的返回值大于0时，表示发送或接收多少字节。这种情况下要判断send函数返回值是不是我们期望发送的字节数，而不是简单判断其返回值大于0。</p>
<p>对端的TCP窗口可能因为缺少一部分字节就满了，所以n的值可能为(0, buf_length]。当0 &lt; n &lt; buf_length时，虽然此时send函数调用成功，但在业务上并不算正确，因为有部分数据并没有被发送出去。所以，要么在返回值n等于buf_length时才认为是正确的，要么在一个循环中调用send函数，如果数据一次性发送不完，则记录偏移量，下一次从偏移量接着发送，直到全部发送完为止。</p>
<ul>
<li><strong>返回值等于0</strong></li>
</ul>
<p>通常情况下如果send或recv函数返回0，就认为对端关闭了连接。但有一种特殊情况，send主动发送0字节时也会返回0.</p>
<ul>
<li><strong>返回值小于0</strong></li>
</ul>
<table>
<thead>
<tr>
<th>返回值和错误码</th>
<th>send函数</th>
<th>recv函数</th>
<th>操作系统</th>
</tr>
</thead>
<tbody><tr>
<td>返回-1，错误码EWOUDBLOCK或EAGAIN</td>
<td>TCP窗口太小，暂时发不出去</td>
<td>在当前内核缓冲区中无可读数据</td>
<td>Linux</td>
</tr>
<tr>
<td>返回-1，错误码是EINTR</td>
<td>被信号中断，需要重试</td>
<td>被信号中断，需要重试</td>
<td>Linux</td>
</tr>
<tr>
<td>返回-1，错误码不是以上3种</td>
<td>出错</td>
<td>出错</td>
<td>Linux</td>
</tr>
<tr>
<td>返回-1，错误码是WSAEWOUDBLOCK</td>
<td>TCP窗口太小，暂时发不出去</td>
<td>在当前内核缓冲区中无可读数据</td>
<td>Windows</td>
</tr>
<tr>
<td>返回-1，错误码不是WSAEWOUDBLOCK</td>
<td>出错</td>
<td>出错</td>
<td>Windows</td>
</tr>
</tbody></table>
<p>阻塞的socket函数在调用send、recv、connect、accept等函数时，特定条件不满足，就会阻塞其调用线程直至超时，非阻塞的socket相反。</p>
<p>非阻塞模式一般用于需要支持高并发多QPS的场景（如服务器程序），但依照小demo来看，这种模式让程序控制逻辑变得复杂；阻塞模式的逻辑简单，程序结构简单明了，用于特殊场景：例如：</p>
<p>（1）文件分段发送，每发送一段，对端都会给予一个响应，该程序可以单独开一个任务线程，send和recv依次交替，并且每次send和recv都是阻塞的。</p>
<p>（2）客户端与服务端只有问答模式，客户端发给服务端一个请求，服务端必定给客户端一个响应，除此之外不会推送任何数据，每次send完请求后，都可以直接使用阻塞式的recv函数接收应答包。</p>
<h1 id="发送0字节数据的效果"><a href="#发送0字节数据的效果" class="headerlink" title="发送0字节数据的效果"></a>发送0字节数据的效果</h1><p>之前提到send或recv返回0表示对端关闭了连接，但如果真的发送一个长度为0的数据，对端是否会收到这给0字节数据呢，服务端代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> clientfd;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">	clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr *)&amp;clientaddr, &amp;clientaddrlen);</span><br><span class="line">	<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">char</span> recvBuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">recv</span>(clientfd, recvBuf, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv data from client, data: &quot;</span> &lt;&lt; recvBuf</span><br><span class="line">					&lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv 0 byte data. &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;recv data error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SERVER_PORT);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置为非阻塞模式</span></span><br><span class="line">	<span class="comment">//不能在创建成功时就设置，会影响道connect</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set socket to nonblock error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">send</span>(clientfd, SEND_DATA, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//非阻塞模式下，send函数由于TCP窗口太小，发不出数据，错误码是EWOULDBLOCK</span></span><br><span class="line">			<span class="keyword">if</span> (errno == EWOULDBLOCK)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;send data error as TCP Window size is too small&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;sending data interrupted by signal&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;send data error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;send 0 byte data &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			++count;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;send data successfully, count = &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务端和客户端</p>
<p><img src="./27.png" alt="27"></p>
<p>send函数每隔3s发送一段0字节数据，利用lsof -i -Pn查看连接状态：</p>
<p><img src="./28.png" alt="28"></p>
<p>利用tcpdump抓取经过端口3000的数据包:</p>
<p><img src="./29.png" alt="29"></p>
<p>在send函数发送0字节时，tcpdump只有3次握手的数据包，也就是说这些由send函数发出的0字节数据并没有真正的发出去。</p>
<p>利用gdb调用服务端，经典run命令、Ctrl+C、backtrace命令</p>
<p><img src="./30.png" alt="30"></p>
<p>服务端阻塞在recv函数调用处，因此在send发送0字节返回0的情况下，recv是不会收到0字节数据的，只有断开连接时才会收到。</p>
<h1 id="connect函数阻塞和非阻塞下的行为"><a href="#connect函数阻塞和非阻塞下的行为" class="headerlink" title="connect函数阻塞和非阻塞下的行为"></a>connect函数阻塞和非阻塞下的行为</h1><p>创建异步connect技术（非阻塞connect）一般有以下步骤：</p>
<ul>
<li>创建socket，将socket设置为非阻塞模式</li>
<li>调用connect函数，无论connect函数是否连接成功，都会立即返回；如果返回-1，则并不一定表示连接出错，如果此时错误码是EINPROGRESS，则表示正在尝试连接。</li>
<li>调用select函数，在指定的时间内判断该socket是否可写，如果可写，则说明连接成功，反之认为连接失败。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置非阻塞</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set socket to nonblock error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SERVER_PORT);</span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr,</span><br><span class="line">			<span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr));</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;connect to server successfully &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="built_in">close</span>(clientfd);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//connect动作被信号中断，重试connect</span></span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;connectint interruptted by signal, try again&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (errno == EINPROGRESS)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//连接正在尝试中</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//出错</span></span><br><span class="line">				<span class="built_in">close</span>(clientfd);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fd_set writeset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;writeset);</span><br><span class="line">	<span class="built_in">FD_SET</span>(clientfd, &amp;writeset);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">	tv.tv_sec;</span><br><span class="line">	tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//调用select判断socket是否可写</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">select</span>(clientfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writeset, <span class="literal">NULL</span>, &amp;tv) == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[select] connect to server successfully &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[select] connect to server error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用nc命令启动一个服务端程序</p>
<p><img src="./31.png" alt="31"></p>
<p>编译客户端并连接</p>
<p><img src="./32.png" alt="32"></p>
<p>额，但是发现开不开服务器都显示连接成功，原因如下：</p>
<ul>
<li>在Windows上，socket没有建立连接之前使用select函数检测是否可写，能得到不可写，连接成功检测后检测，会变为可写。上述逻辑在Windows上没有问题。</li>
<li>在Linux上，一个socket没有建立之前，用select函数检测其是否可写，会得到可写，所以上述逻辑不适应Linux。Linux上，在 connect之后不仅要调用select检测是否可写，还要调用getsockopt检测socket是否出错，通过错误码来检测和确定是否连接上，错误码为0表示连接上。反之没连接上。</li>
</ul>
<p>修改代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置非阻塞</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set socket to nonblock error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SERVER_PORT);</span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">connect</span>(clientfd, (struct sockaddr *)&amp;serveraddr,</span><br><span class="line">			<span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr));</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;connect to server successfully &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="built_in">close</span>(clientfd);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//connect动作被信号中断，重试connect</span></span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;connectint interruptted by signal, try again&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (errno == EINPROGRESS)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//连接正在尝试中</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//出错</span></span><br><span class="line">				<span class="built_in">close</span>(clientfd);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fd_set writeset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;writeset);</span><br><span class="line">	<span class="built_in">FD_SET</span>(clientfd, &amp;writeset);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">	tv.tv_sec;</span><br><span class="line">	tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//调用select判断socket是否可写</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">select</span>(clientfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writeset, <span class="literal">NULL</span>, &amp;tv) != <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[select] connect to server successfully &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">socklen_t</span> len = <span class="keyword">static_cast</span>&lt;<span class="keyword">socklen_t</span>&gt;(<span class="keyword">sizeof</span> err);</span><br><span class="line">	<span class="comment">//调用getsockopt检测此时socket是否出错</span></span><br><span class="line">	<span class="keyword">if</span> (::<span class="built_in">getsockopt</span>(clientfd, SOL_SOCKET, SO_ERROR, &amp;err, &amp;len) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (err == <span class="number">0</span>)</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect to server successfully &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect to server error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./33.png" alt="33"></p>
<h1 id="Linux-poll函数的用法"><a href="#Linux-poll函数的用法" class="headerlink" title="Linux poll函数的用法"></a>Linux poll函数的用法</h1><p>poll函数用于检测一组文件描述符(File Descriptor,简称fd)上的可读可写和出错事件，其函数签名如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(struct pollfd* fds, <span class="keyword">nfds_t</span>, <span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"><span class="comment">//参数fds是指向一个结构体数组首个元素的指针，每个数组元素都是一个struct pollfd结构，用于指定检测某个给定的fd的条件，struct pollfd结构体定义如下：</span></span><br><span class="line"><span class="comment">//struct pollfd&#123;</span></span><br><span class="line"><span class="comment">//    int    fd;             /*待检测事件的fd      */</span></span><br><span class="line"><span class="comment">//    short  events;         /*关心的事件组合      */</span></span><br><span class="line"><span class="comment">//    short  revents;        /*检测后得到的事件类型*/</span></span><br><span class="line"><span class="comment">//&#125;;</span></span><br><span class="line"><span class="comment">//参数nfds是fds结构体数组的长度，本质上是unsigned long int 定义如下：</span></span><br><span class="line"><span class="comment">//typedef unsigned long int nfds_t;</span></span><br><span class="line"><span class="comment">//参数timeout表示poll函数的超时时间，单位为毫秒。    </span></span><br></pre></td></tr></table></figure>

<p>struct pollfd的events字段是由开发者设置的，告诉内核关注什么事件；而revents字段是poll函数返回时内核设置的，说明该fd发生了什么事件。event和revents一般有下表所示取值：</p>
<table>
<thead>
<tr>
<th>事件宏</th>
<th>事件描述</th>
<th>是否可以作为输入(events)</th>
<th>是否可以作为输出(revents)</th>
</tr>
</thead>
<tbody><tr>
<td>POLLIN</td>
<td>数据可读（包括普通数据&amp;优先数据）</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLOUT</td>
<td>数据可写（普通数据&amp;优先数据）</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLRDNORM</td>
<td>等同于POLLIN</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLRDBAND</td>
<td>优先级带数据可读</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLPRI</td>
<td>高优秀级数据可读，例如TCP带外数据</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLWRNORM</td>
<td>等同于POLLOUT</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLWRBAND</td>
<td>优先级带数据可写</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLRDHUP</td>
<td>TCP连接被对端关闭，或者关闭了写操作，由GNU引入</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POPPHUP</td>
<td>挂起</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>POLLERR</td>
<td>错误</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>POLLNVAL</td>
<td>文件描述符没有打开</td>
<td>否</td>
<td>是</td>
</tr>
</tbody></table>
<p>poll检测一组fd上的可读可写和出错事件的概念与前面介绍select的事件含义一样。poll与select相比有以下优点：</p>
<ul>
<li>poll不要求开发者计算最大文件描述符加1的大小。</li>
<li>与select相比，poll在处理大数量的文件描述符时速度更快。</li>
<li>poll没有最大连接数的限制，因为其存储fd的数组没有长度限制。</li>
<li>在调用poll函数时，只需对参数进行一次设置。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_ADDRESS = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SERVER_PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> SEND_DATA = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (clientfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create client socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set socket nonblock error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">	serveraddr.sin_family = AF_INET;</span><br><span class="line">	serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(SERVER_ADDRESS);</span><br><span class="line">	serveraddr.sin_port = <span class="built_in">htons</span>(SERVER_PORT);</span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">connect</span>(clientfd, (struct sockaddr*)&amp;serveraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(serveraddr));</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;connect to server successfully &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="built_in">close</span>(clientfd);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//connect被信号中断，重试connect</span></span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;connecting interruptted by singl, try again &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (errno == EINPROGRESS)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//尝试重连</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//出错</span></span><br><span class="line">				<span class="built_in">close</span>(clientfd);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pollfd event;</span><br><span class="line">	event.fd = clientfd;</span><br><span class="line">	event.events = POLLOUT;</span><br><span class="line">	<span class="keyword">int</span> timeout = <span class="number">3000</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">poll</span>(&amp;event, <span class="number">1</span>, timeout) != <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[poll] connect to server error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!(event.revents &amp; POLLOUT))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[POLLOUT] connect to server error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">socklen_t</span> len = <span class="keyword">static_cast</span>&lt;<span class="keyword">socklen_t</span>&gt;(<span class="keyword">sizeof</span> err);</span><br><span class="line">	<span class="keyword">if</span> (::<span class="built_in">getsockopt</span>(clientfd, SOL_SOCKET, SO_ERROR, &amp;err, &amp;len) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span> (err == <span class="number">0</span>)</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect to server successfully &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;connect to server error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="built_in">close</span>(clientfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用nc指令模拟服务器，再编译启动客户端</p>
<p><img src="./37.png" alt="37"></p>
<p><img src="./36.png" alt="36"></p>
<p>和select结果一致。</p>
<h1 id="如何获取当前socket对应的接收缓冲区中的可读数据"><a href="#如何获取当前socket对应的接收缓冲区中的可读数据" class="headerlink" title="如何获取当前socket对应的接收缓冲区中的可读数据"></a>如何获取当前socket对应的接收缓冲区中的可读数据</h1><p>Windows上使用ioctlsocket这个API函数，签名如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctlsocket</span><span class="params">(SOCKET s, <span class="keyword">long</span> cmd, u_long* argp)</span></span>;</span><br><span class="line"><span class="comment">//参数s是需要操作的socket句柄</span></span><br><span class="line"><span class="comment">//参数cmd是对应的操作类型</span></span><br><span class="line"><span class="comment">//参数argp存储操作后的结果</span></span><br><span class="line"><span class="comment">//成功返回0，失败返回非0</span></span><br></pre></td></tr></table></figure>

<p>Linux上用ioctl函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> d, <span class="keyword">int</span> request, ……)</span></span>;</span><br><span class="line"><span class="comment">//参数d是需要操作的socket句柄</span></span><br><span class="line"><span class="comment">//request是对应的操作类型</span></span><br><span class="line"><span class="comment">//成功返回0，失败返回非0</span></span><br></pre></td></tr></table></figure>

<p>服务端代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> INVALID_FD = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == INVALID_FD)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socket error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置socket为非阻塞</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(listenfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(listenfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set  listenfd to nonblock error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//复用地址和端口号</span></span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="keyword">char</span> *)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEPORT, (<span class="keyword">char</span> *)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="comment">//初始化服务器地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr *)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	std::vector&lt;pollfd&gt; fds;</span><br><span class="line">	pollfd listen_fd_info;</span><br><span class="line">	listen_fd_info.fd = listenfd;</span><br><span class="line">	listen_fd_info.events = POLLIN;</span><br><span class="line">	listen_fd_info.revents = <span class="number">0</span>;</span><br><span class="line">	fds.<span class="built_in">push_back</span>(listen_fd_info);</span><br><span class="line">	<span class="comment">//是否存在无效的fd标志</span></span><br><span class="line">	<span class="keyword">bool</span> exist_invalid_fd;</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		exist_invalid_fd = <span class="literal">false</span>;</span><br><span class="line">		n = <span class="built_in">poll</span>(&amp;fds[<span class="number">0</span>], fds.<span class="built_in">size</span>(), <span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">//出错，退出循环</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//超时，继续</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> size = fds.<span class="built_in">size</span>();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; size; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//事件可读</span></span><br><span class="line">			<span class="keyword">if</span> (fds[i].revents &amp; POLLIN)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (fds[i].fd == listenfd)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//监听socket，接受新连接</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">					<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">					<span class="comment">//接受客户端连接并将产生的clientfd加入fds集合中</span></span><br><span class="line">					<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr *)&amp;clientaddr,</span><br><span class="line">						&amp;clientaddrlen);</span><br><span class="line">					<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//将客户端设置成非阻塞</span></span><br><span class="line">						<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">close</span>(clientfd);</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;set clientfd to nonblock error &quot;</span></span><br><span class="line">								&lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							struct pollfd client_fd_info;</span><br><span class="line">							client_fd_info.fd = clientfd;</span><br><span class="line">							client_fd_info.events = POLLIN;</span><br><span class="line">							client_fd_info.revents = <span class="number">0</span>;</span><br><span class="line">							fds.<span class="built_in">push_back</span>(client_fd_info);</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;new client accepted, clientfd: &quot;</span></span><br><span class="line">								&lt;&lt; clientfd &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//在socket可读时获取当前接收缓存区的字节数</span></span><br><span class="line">					ulong bytesToRecv = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">if</span> (<span class="built_in">ioctl</span>(fds[i].fd, FIONREAD, &amp;bytesToRecv) == <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						std::cout &lt;&lt; <span class="string">&quot;bytesToRecv&quot;</span> &lt;&lt; bytesToRecv &lt;&lt; std::endl;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">//普通clientfd,收取数据</span></span><br><span class="line">					<span class="keyword">char</span> buf[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">					<span class="keyword">int</span> m = <span class="built_in">recv</span>(fds[i].fd, buf, <span class="number">64</span>, <span class="number">0</span>);</span><br><span class="line">					<span class="keyword">if</span> (m &lt;= <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span> (errno != EINTR &amp;&amp; errno != EWOULDBLOCK)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">//出错或对端关闭连接，关闭对应的clientfd，并设置无效标志位</span></span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;client disconnected, clientfd: &quot;</span> &lt;&lt; fds[i].fd</span><br><span class="line">								&lt;&lt; std::endl;</span><br><span class="line">							<span class="built_in">close</span>(fds[i].fd);</span><br><span class="line">							fds[i].fd = INVALID_FD;</span><br><span class="line">							exist_invalid_fd = <span class="literal">true</span>;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						std::cout &lt;&lt; <span class="string">&quot;recv from client: &quot;</span> &lt;&lt; buf &lt;&lt; <span class="string">&quot;. clientfd: &quot;</span></span><br><span class="line">							&lt;&lt; fds[i].fd &lt;&lt; std::endl;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (fds[i].revents &amp; POLLERR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//TODO :暂不处理</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (exist_invalid_fd)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//清理无效的fd</span></span><br><span class="line">			<span class="keyword">for</span> (std::vector&lt;pollfd&gt;::iterator iter = fds.<span class="built_in">begin</span>(); iter != fds.<span class="built_in">end</span>();)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (iter-&gt;fd == INVALID_FD)</span><br><span class="line">					iter = fds.<span class="built_in">erase</span>(iter);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					++iter;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (std::vector&lt;pollfd&gt;::iterator iter = fds.<span class="built_in">begin</span>(); iter != fds.<span class="built_in">end</span>(); ++iter)</span><br><span class="line">		<span class="built_in">close</span>(iter-&gt;fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用poll函数检测在监听socket和clientsocket上是否有可读事件。对于clientsocket，当触发其可读事件(POLLIN)时表明有数据可读，调用ioctl函数获取当前socket接收缓冲区的字节数并将其打印出来。利用nc命令模拟客户端进行测试：</p>
<p><img src="./34.png" alt="34"></p>
<p><img src="./35.png" alt="35"></p>
<h1 id="Linux-epoll模型"><a href="#Linux-epoll模型" class="headerlink" title="Linux epoll模型"></a>Linux epoll模型</h1><p>综合selct和poll的一些优缺点，Linux从内核2.6版本开始引入了更高效的epoll模型。</p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>使用epoll模型之前必须创建epollfd，需要用到epoll_create函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span>;</span><br><span class="line"><span class="comment">//参数size从Linux2.6.8以后就不再使用，但必须设置一个大于0的值</span></span><br><span class="line"><span class="comment">//成功返回一个非负值的epollfd，失败返回-1</span></span><br></pre></td></tr></table></figure>

<p>接下来利用epoll_ctl函数将需要检测的事件fd绑定到这个epollfd上，或修改已绑定fd的事件类型，或将fd从epollfd上解绑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event* event)</span></span>;</span><br><span class="line"><span class="comment">//参数epfd是之前创建好的epollfd</span></span><br><span class="line"><span class="comment">//参数op是操作类型，取值有EPOLL_CTL_ADD、EPOLL_CTL_MOD和EPOLL_CTL_DEL，分别表示在epollfd上添加、修改和移除fd，当取值是EPOLL_CTL_DEL时，第四个参数event忽略不计。</span></span><br><span class="line"><span class="comment">//参数fd是需要被操作的id</span></span><br><span class="line"><span class="comment">//参数event是一个epoll_event结构体的地址，epoll_event结构体定义如下：</span></span><br><span class="line"><span class="comment">//struct epoll_event</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    uint32_t     events;       /*需要检测的fd事件标志*/</span></span><br><span class="line"><span class="comment">//    epoll_data_t data;         /*用户自定义的数据*/</span></span><br><span class="line"><span class="comment">//&#125;;</span></span><br><span class="line"><span class="comment">//参数data的类型是epoll_data_t，可以设置一个自定义数据，本质上是个Union对象</span></span><br><span class="line"><span class="comment">//typedef union epoll_data</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    void*      ptr;</span></span><br><span class="line"><span class="comment">//    int        fd;</span></span><br><span class="line"><span class="comment">//    uint32_t   u32;</span></span><br><span class="line"><span class="comment">//    uint64_t   u64;</span></span><br><span class="line"><span class="comment">//&#125;epoll_data_t;</span></span><br><span class="line"><span class="comment">//epoll_ctl调用成功返回0，失败返回-1</span></span><br></pre></td></tr></table></figure>

<p>将fd绑定在epollfd上之后，就可以调用epoll_wait检测事件了，函数签名如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event* event, <span class="keyword">int</span> maxevents,<span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"><span class="comment">//参数events是一个epoll_event结构数组的首地址，调用成功后event存放的是与就绪事件相关的epoll_event结构体数组。</span></span><br><span class="line"><span class="comment">//参数maxevents是数组元素的个数。</span></span><br><span class="line"><span class="comment">//参数timeout是超时时间，单位是毫秒，如果设置为0，epoll_wait会立即返回。</span></span><br><span class="line"><span class="comment">//成功返回有事件的fd数量，返回0表示超时，调用失败返回-1.</span></span><br></pre></td></tr></table></figure>

<h2 id="epoll-wait与poll函数的区别"><a href="#epoll-wait与poll函数的区别" class="headerlink" title="epoll_wait与poll函数的区别"></a>epoll_wait与poll函数的区别</h2><p>epoll_wait函数调用成功后，通过第一个参数event就可以获得所有有事件就绪的fd，而poll函数中的事件合集数量前后不会改变。也就是说epoll_wait函数会自动将所需要的事件筛选出来，而poll函数只是打上标签，筛选还需全体遍历。</p>
<h2 id="LT模式和ET模式"><a href="#LT模式和ET模式" class="headerlink" title="LT模式和ET模式"></a>LT模式和ET模式</h2><p>与poll事件宏相比，epoll模式新增了一个事件宏EPOLLET，即边缘触发模式（Edge Trigger， ET），我们称默认的模式为水平触发模式（Level Trigger， LT），区别在于：</p>
<p>（1）水平触发模式，一个事件只要有。就会一直触发。</p>
<p>（2）边缘触发模式，在一个事件从无到有时才会触发。</p>
<p>fd上有数据的状态认为是高电平状态，将没有数据的状态认为是低电平状态，将fd可写状态认为是高电平状态，将fd不可写状态认为是低电平状态。那么水平模式触发条件是处于高电平状态，而边缘模式的触发条件是新来的一次电信号将当前状态变为高电平状态。</p>
<p>水平模式的触发条件：①低电平→高电平；②处于高电平状态</p>
<p>边缘模式的触发条件：低电平→高电平</p>
<p>以socket的读事件为例，对于水平模式，只要在socket上有未读完的数据，就会一直产生EPOLLIN事件；对于边缘模式，socket上每新来一次数据就会触发一次，如果上一次触发后未将socket上的数据读完，也不会再触发，除非新来一次数据。对于socket写事件如果socket的TCP窗口一直不饱和，就会一直触发EPOLLOUT事件；而对于边缘模式，只会触发一次，除非TCP窗口由不饱和变饱和再一次变成不饱和，才会再次触发EPOLLOUT事件。</p>
<p>socket可读事件的水平模式触发条件：①socket上无数据→socket上有数据；②socket处于有数据状态</p>
<p>socket可读事件的边缘模式触发条件：①socket上无数据→socket上有数据；②socket又新来一次数据。</p>
<p>socket可写事件的水平模式触发条件：①socket可写→socket不可写；②socket不可写→socket可写。</p>
<p>socket可写事件的边缘模式触发条件：socket不可写→socket可写。</p>
<p>对于非阻塞socket，如果使用epoll边缘模式检测数据是否可读，则触发可读事件后，一定要一次性地把socket上的数据收取干净，即循环调用recv函数直到出错，错误码是EWOULDBLOCK(EAGAIN也一样，表示socket上的本次数据已经读完)，边缘模式伪代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">TcpSession::RecvEtMode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//每次收取256字节</span></span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">256</span>];</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> nRecv = ::<span class="built_in">recv</span>(m_clientfd, buff, <span class="number">256</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (nRecv == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno = EWOULDBLOCK)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (nRecv == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		m_inputBuffer.<span class="built_in">add</span>(buff, (<span class="keyword">size_t</span>)nRecv);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LT模式和ET模式处理读："><a href="#LT模式和ET模式处理读：" class="headerlink" title="LT模式和ET模式处理读："></a><strong>LT模式和ET模式处理读：</strong></h2><p>LT模式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socker error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置重用IP地址和端口号</span></span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="keyword">char</span>*)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEPORT, (<span class="keyword">char</span>*)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="comment">//设置socket非阻塞</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(listenfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(listenfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set listen socket to nonblock error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> epollfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (epollfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create epollfd error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	epoll_event listen_fd_event;</span><br><span class="line">	listen_fd_event.data.fd = listenfd;</span><br><span class="line">	listen_fd_event.events = EPOLLIN;</span><br><span class="line">	<span class="comment">//若取消注释这行，则使用ET模式</span></span><br><span class="line"><span class="comment">//	listen_fd_event.events |= EPOLLET;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//监听socket绑定到epollfd</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listenfd, &amp;listen_fd_event) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;epoll_ctl error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		epoll_event epoll_events[<span class="number">1024</span>];</span><br><span class="line">		n = <span class="built_in">epoll_wait</span>(epollfd, epoll_events, <span class="number">1024</span>, <span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//信号中断</span></span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">//出错</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//超时，继续</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLIN)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (epoll_events[i].data.fd == listenfd)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//监听socket，接收新连接</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">					<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">					<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;clientaddr, &amp;clientaddrlen);</span><br><span class="line">					<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//设置非阻塞</span></span><br><span class="line">						<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">close</span>(clientfd);</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;set clientfd to nonblocking error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							epoll_event client_fd_event;</span><br><span class="line">							client_fd_event.data.fd = clientfd;</span><br><span class="line">							client_fd_event.events = EPOLLIN;</span><br><span class="line">							<span class="comment">//若取消注释这行，则使用ET模式</span></span><br><span class="line">							<span class="comment">//client_fd_event.events |= EPOLLET;</span></span><br><span class="line">							<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, clientfd, &amp;client_fd_event) != <span class="number">-1</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;new client accepted, clientfd: &quot;</span> &lt;&lt; clientfd &lt;&lt; std::endl;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">else</span></span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;add client fd to epollfd error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">								<span class="built_in">close</span>(clientfd);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;client fd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; <span class="string">&quot;recv data&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="comment">//普通clientfd</span></span><br><span class="line">					<span class="keyword">char</span> ch;</span><br><span class="line">					<span class="comment">//每次只接收1字节</span></span><br><span class="line">					<span class="keyword">int</span> m = <span class="built_in">recv</span>(epoll_events[i].data.fd, &amp;ch, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">					<span class="keyword">if</span> (m == <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//对端关闭了连接，从epollfd上移除clientfd</span></span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, epoll_events[i].data.fd, <span class="literal">NULL</span>) != <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;client disconnected, clientfd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="built_in">close</span>(epoll_events[i].data.fd);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> (m &lt; <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//出错</span></span><br><span class="line">						<span class="keyword">if</span> (errno != EWOULDBLOCK &amp;&amp; errno != EINTR)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, epoll_events[i].data.fd, <span class="literal">NULL</span>) != <span class="number">-1</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;client disconnected, clientfd:&quot;</span></span><br><span class="line">									&lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="built_in">close</span>(epoll_events[i].data.fd);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						std::cout &lt;&lt; <span class="string">&quot;recv from client:&quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; ch &lt;&lt; std::endl;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLERR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//TODO 暂不处理</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译启动服务端，利用nc命令模拟客户端向服务端发送’abcdefg’</p>
<p><img src="./39.png" alt="39"></p>
<p><img src="./38.png" alt="38"></p>
<p>nc命令实际发送了a、b、c、d、e、f、\n这8个字符，服务器用的是LT模式，每次接收一个字符，但只要socket缓冲区中仍有数据可读，POLLIN事件就会一直触发，所以服务端有8次输出。</p>
<p>将代码间的注释去掉，换成ET模式，重新编译启动服务端，利用nc命令模拟客户端向服务端发送’abcdefg’。</p>
<p><img src="./40.png" alt="40"></p>
<p><img src="./41.png" alt="41"></p>
<p>ET模式只会触发一次POLLIN事件，如果没有新数据到来，则再也不会触发，继续向服务端发送’abc‘</p>
<p><img src="./42.png" alt="42"></p>
<p><img src="./43.png" alt="43"></p>
<p>使用ET模式时，在一次POLLIN事件中就要把socket上的数据收完。</p>
<h2 id="LT模式和ET模式处理写"><a href="#LT模式和ET模式处理写" class="headerlink" title="LT模式和ET模式处理写"></a>LT模式和ET模式处理写</h2><p>LT模式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socker error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置重用IP地址和端口号</span></span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="keyword">char</span>*)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEPORT, (<span class="keyword">char</span>*)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="comment">//设置socket非阻塞</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(listenfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(listenfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set listen socket to nonblock error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> epollfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (epollfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create epollfd error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	epoll_event listen_fd_event;</span><br><span class="line">	listen_fd_event.data.fd = listenfd;</span><br><span class="line">	listen_fd_event.events = EPOLLIN;</span><br><span class="line">	<span class="comment">//若取消注释这行，则使用ET模式</span></span><br><span class="line">	<span class="comment">//listen_fd_event.events |= EPOLLET;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//监听socket绑定到epollfd</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listenfd, &amp;listen_fd_event) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;epoll_ctl error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		epoll_event epoll_events[<span class="number">1024</span>];</span><br><span class="line">		n = <span class="built_in">epoll_wait</span>(epollfd, epoll_events, <span class="number">1024</span>, <span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//信号中断</span></span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">//出错</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//超时，继续</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLIN)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (epoll_events[i].data.fd == listenfd)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//监听socket，接收新连接</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">					<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">					<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;clientaddr, &amp;clientaddrlen);</span><br><span class="line">					<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//设置非阻塞</span></span><br><span class="line">						<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">close</span>(clientfd);</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;set clientfd to nonblocking error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							epoll_event client_fd_event;</span><br><span class="line">							client_fd_event.data.fd = clientfd;</span><br><span class="line">							client_fd_event.events = EPOLLIN | EPOLLOUT;</span><br><span class="line">							<span class="comment">//若取消注释这行，则使用ET模式</span></span><br><span class="line">							<span class="comment">//client_fd_event.events |= EPOLLET;</span></span><br><span class="line">							<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, clientfd, &amp;client_fd_event) != <span class="number">-1</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;new client accepted, clientfd: &quot;</span> &lt;&lt; clientfd &lt;&lt; std::endl;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">else</span></span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;add client fd to epollfd error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">								<span class="built_in">close</span>(clientfd);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;client fd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; <span class="string">&quot;recv data&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="comment">//普通clientfd</span></span><br><span class="line">					<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">					<span class="keyword">int</span> m = <span class="built_in">recv</span>(epoll_events[i].data.fd, recvbuf, <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">					<span class="keyword">if</span> (m == <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//对端关闭了连接，从epollfd上移除clientfd</span></span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, epoll_events[i].data.fd, <span class="literal">NULL</span>) != <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;client disconnected, clientfd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="built_in">close</span>(epoll_events[i].data.fd);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> (m &lt; <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//出错</span></span><br><span class="line">						<span class="keyword">if</span> (errno != EWOULDBLOCK &amp;&amp; errno != EINTR)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, epoll_events[i].data.fd, <span class="literal">NULL</span>) != <span class="number">-1</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;client disconnected, clientfd:&quot;</span></span><br><span class="line">									&lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="built_in">close</span>(epoll_events[i].data.fd);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						std::cout &lt;&lt; <span class="string">&quot;recv from client:&quot;</span> &lt;&lt; epoll_events[i].data.fd </span><br><span class="line">							&lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; recvbuf &lt;&lt; std::endl;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLOUT)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//只处理客户端fd的可写事件</span></span><br><span class="line">				<span class="keyword">if</span> (epoll_events[i].data.fd != listenfd)</span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;EPOLLOUT triggered, clientfd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLERR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//TODO 暂不处理</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./44.png" alt="44"></p>
<p>LT模式下，服务端对应的客户端fd一直可写，有写事件一直触发，所以屏幕不断输出</p>
<p>改成ET：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create listen socker error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置重用IP地址和端口号</span></span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="keyword">char</span>*)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEPORT, (<span class="keyword">char</span>*)&amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on));</span><br><span class="line">	<span class="comment">//设置socket非阻塞</span></span><br><span class="line">	<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(listenfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">fcntl</span>(listenfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;set listen socket to nonblock error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">bindaddr</span>;</span></span><br><span class="line">	bindaddr.sin_family = AF_INET;</span><br><span class="line">	bindaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	bindaddr.sin_port = <span class="built_in">htons</span>(<span class="number">3000</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;bindaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(bindaddr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind listen socket error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> epollfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (epollfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;create epollfd error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	epoll_event listen_fd_event;</span><br><span class="line">	listen_fd_event.data.fd = listenfd;</span><br><span class="line">	listen_fd_event.events = EPOLLIN;</span><br><span class="line">	<span class="comment">//若取消注释这行，则使用ET模式</span></span><br><span class="line">	<span class="comment">//listen_fd_event.events |= EPOLLET;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//监听socket绑定到epollfd</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listenfd, &amp;listen_fd_event) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;epoll_ctl error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">close</span>(listenfd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		epoll_event epoll_events[<span class="number">1024</span>];</span><br><span class="line">		n = <span class="built_in">epoll_wait</span>(epollfd, epoll_events, <span class="number">1024</span>, <span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//信号中断</span></span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">//出错</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//超时，继续</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLIN)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (epoll_events[i].data.fd == listenfd)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//监听socket，接收新连接</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">					<span class="keyword">socklen_t</span> clientaddrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(clientaddr);</span><br><span class="line">					<span class="keyword">int</span> clientfd = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;clientaddr, &amp;clientaddrlen);</span><br><span class="line">					<span class="keyword">if</span> (clientfd != <span class="number">-1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//设置非阻塞</span></span><br><span class="line">						<span class="keyword">int</span> oldSocketFlag = <span class="built_in">fcntl</span>(clientfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">int</span> newSocketFlag = oldSocketFlag | O_NONBLOCK;</span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">fcntl</span>(clientfd, F_SETFL, newSocketFlag) == <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">close</span>(clientfd);</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;set clientfd to nonblocking error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							epoll_event client_fd_event;</span><br><span class="line">							client_fd_event.data.fd = clientfd;</span><br><span class="line">							client_fd_event.events = EPOLLIN | EPOLLOUT;</span><br><span class="line">							<span class="comment">//若取消注释这行，则使用ET模式</span></span><br><span class="line">							client_fd_event.events |= EPOLLET;</span><br><span class="line">							<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, clientfd, &amp;client_fd_event) != <span class="number">-1</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;new client accepted, clientfd: &quot;</span> &lt;&lt; clientfd &lt;&lt; std::endl;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">else</span></span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;add client fd to epollfd error &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">								<span class="built_in">close</span>(clientfd);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;client fd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; <span class="string">&quot;recv data&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="comment">//普通clientfd</span></span><br><span class="line">					<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">					<span class="keyword">int</span> m = <span class="built_in">recv</span>(epoll_events[i].data.fd, recvbuf, <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">					<span class="keyword">if</span> (m == <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//对端关闭了连接，从epollfd上移除clientfd</span></span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, epoll_events[i].data.fd, <span class="literal">NULL</span>) != <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;client disconnected, clientfd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="built_in">close</span>(epoll_events[i].data.fd);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> (m &lt; <span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//出错</span></span><br><span class="line">						<span class="keyword">if</span> (errno != EWOULDBLOCK &amp;&amp; errno != EINTR)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, epoll_events[i].data.fd, <span class="literal">NULL</span>) != <span class="number">-1</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								std::cout &lt;&lt; <span class="string">&quot;client disconnected, clientfd:&quot;</span></span><br><span class="line">									&lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="built_in">close</span>(epoll_events[i].data.fd);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						std::cout &lt;&lt; <span class="string">&quot;recv from client:&quot;</span> &lt;&lt; epoll_events[i].data.fd </span><br><span class="line">							&lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; recvbuf &lt;&lt; std::endl;</span><br><span class="line">						epoll_event client_fd_event;</span><br><span class="line">						client_fd_event.data.fd = epoll_events[i].data.fd;</span><br><span class="line">						<span class="comment">//再次给clientfd注册检测可写事件</span></span><br><span class="line">						client_fd_event.events = EPOLLIN | EPOLLOUT | EPOLLET;</span><br><span class="line">						<span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_MOD, epoll_events[i].data.fd, &amp;client_fd_event) != <span class="number">-1</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							std::cout &lt;&lt; <span class="string">&quot;epoll_ctl successfully, mode:EPOLL_CTL_MOD, clientfd: &quot;</span></span><br><span class="line">								&lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLOUT)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//只处理客户端fd的可写事件</span></span><br><span class="line">				<span class="keyword">if</span> (epoll_events[i].data.fd != listenfd)</span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;EPOLLOUT triggered, clientfd: &quot;</span> &lt;&lt; epoll_events[i].data.fd &lt;&lt; std::endl;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (epoll_events[i].events &amp; EPOLLERR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//TODO 暂不处理</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./45.png" alt="45"></p>
<p><img src="./46.png" alt="46"></p>
<p>服务端给客户端fd注册了检测可写事件，可写事件也不会一直触发，只会触发一次，触发完成后只有再次注册、检测可写事件时，可写事件才会继续触发。</p>
<p>在LT模式下，如果依赖可写事件去发送数据，那么一定要在数据发送完成后移除检测可写事件，避免无意义的数据反复触发事件。</p>
<p>在ET模式下，如果依赖可写事件区发送数据，如果数据一次没有发完，则一定要继续注册、检测可写事件，否则可写事件不会继续触发，剩余数据发不出去。</p>
<p><strong>结论</strong></p>
<ul>
<li>在LT模式下，读事件触发后可以按需收取想要的字节数，不用把本次接收的数据收取干净（即不用循环到recv或者read函数返回-1，错误码为EWOULDBLOCK或EAGAIN）；在ET模式下，读事件时必须把数据收取干净，因为不一定再有机会收取数据了，即使有机会也可能因为没有即使处理上次没读完的数据，造成客户但响应延迟。</li>
<li>在LT模式下，不需要写事件时一定要及时移除，避免不必要地触发且浪费CPU资源；在ET模式下，写事件触发后，如果还需要下一次的写事件触发来驱动任务，则需要继续注册一次检测可写事件。</li>
<li>LT模式和ET模式各有优缺点，使用LT模式时，可以自由决定每次收取多少字节（对于普通socket）或何时接收连接（对于监听socket），但是可能会导致多次触发；使用ET模式时，必须每次都将数据收完（对于普通socket）或立即调用accept接受连接（对于监听socket），其优点是触发次数少。</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/07/25/gdb/" rel="next" title="必备工具与调试知识">
                <i class="fa fa-chevron-left"></i> 必备工具与调试知识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Socket%E5%87%BD%E6%95%B0"><span class="nav-number">1.</span> <span class="nav-text">Socket函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%BA%93%E7%9A%84socket%E7%94%A8%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">跨平台网络通信库的socket用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#socket%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.1.1.</span> <span class="nav-text">socket数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8WINDOWS%E4%B8%8A%E8%B0%83%E7%94%A8socket%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.2.</span> <span class="nav-text">在WINDOWS上调用socket函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#bind%E5%87%BD%E6%95%B0%E9%87%8D%E9%9A%BE%E7%82%B9%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">bind函数重难点分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#bind%E5%87%BD%E6%95%B0%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BB%91%E5%AE%9A%E5%9C%B0%E5%9D%80"><span class="nav-number">2.1.</span> <span class="nav-text">bind函数如何选择绑定地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bind%E5%87%BD%E6%95%B0%E7%AB%AF%E5%8F%A3%E5%8F%B7"><span class="nav-number">2.2.</span> <span class="nav-text">bind函数端口号</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#select%E5%87%BD%E6%95%B0%E7%9A%84%E7%94%A8%E6%B3%95%E5%92%8C%E5%8E%9F%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">select函数的用法和原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux%E4%B8%8A%E7%9A%84select%E5%87%BD%E6%95%B0"><span class="nav-number">3.1.</span> <span class="nav-text">Linux上的select函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%A0%E7%82%B9%E8%AF%B4%E6%98%8E%EF%BC%9A"><span class="nav-number">3.2.</span> <span class="nav-text">几点说明：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-select%E5%87%BD%E6%95%B0%E7%9A%84%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="nav-number">3.3.</span> <span class="nav-text">Linux select函数的缺点：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#socket%E7%9A%84%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.</span> <span class="nav-text">socket的阻塞模式和非阻塞模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%B0%86socket%E8%AE%BE%E7%BD%AE%E4%B8%BA%E9%9D%9E%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.1.</span> <span class="nav-text">如何将socket设置为非阻塞模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#send%E5%92%8Crecv%E5%87%BD%E6%95%B0%E5%9C%A8%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E8%A1%A8%E7%8E%B0"><span class="nav-number">4.2.</span> <span class="nav-text">send和recv函数在阻塞和非阻塞模式下的表现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#socket%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E4%B8%8Bsend%E5%87%BD%E6%95%B0%E7%9A%84%E8%A1%A8%E7%8E%B0"><span class="nav-number">4.2.1.</span> <span class="nav-text">socket阻塞模式下send函数的表现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#socket%E9%9D%9E%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E4%B8%8Bsend%E5%87%BD%E6%95%B0%E7%9A%84%E8%A1%A8%E7%8E%B0"><span class="nav-number">4.2.2.</span> <span class="nav-text">socket非阻塞模式下send函数的表现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#socket%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E4%B8%8Brecv%E5%87%BD%E6%95%B0%E7%9A%84%E8%A1%A8%E7%8E%B0"><span class="nav-number">4.2.3.</span> <span class="nav-text">socket阻塞模式下recv函数的表现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#socket%E9%9D%9E%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E4%B8%8Brecv%E5%87%BD%E6%95%B0%E7%9A%84%E8%A1%A8%E7%8E%B0"><span class="nav-number">4.2.4.</span> <span class="nav-text">socket非阻塞模式下recv函数的表现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E4%B8%8Bsend%E5%92%8Crecv%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E6%80%BB%E7%BB%93"><span class="nav-number">4.3.</span> <span class="nav-text">非阻塞模式下send和recv函数返回值总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%91%E9%80%810%E5%AD%97%E8%8A%82%E6%95%B0%E6%8D%AE%E7%9A%84%E6%95%88%E6%9E%9C"><span class="nav-number">5.</span> <span class="nav-text">发送0字节数据的效果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#connect%E5%87%BD%E6%95%B0%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E%E4%B8%8B%E7%9A%84%E8%A1%8C%E4%B8%BA"><span class="nav-number">6.</span> <span class="nav-text">connect函数阻塞和非阻塞下的行为</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-poll%E5%87%BD%E6%95%B0%E7%9A%84%E7%94%A8%E6%B3%95"><span class="nav-number">7.</span> <span class="nav-text">Linux poll函数的用法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8Dsocket%E5%AF%B9%E5%BA%94%E7%9A%84%E6%8E%A5%E6%94%B6%E7%BC%93%E5%86%B2%E5%8C%BA%E4%B8%AD%E7%9A%84%E5%8F%AF%E8%AF%BB%E6%95%B0%E6%8D%AE"><span class="nav-number">8.</span> <span class="nav-text">如何获取当前socket对应的接收缓冲区中的可读数据</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-epoll%E6%A8%A1%E5%9E%8B"><span class="nav-number">9.</span> <span class="nav-text">Linux epoll模型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-number">9.1.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll-wait%E4%B8%8Epoll%E5%87%BD%E6%95%B0%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">9.2.</span> <span class="nav-text">epoll_wait与poll函数的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LT%E6%A8%A1%E5%BC%8F%E5%92%8CET%E6%A8%A1%E5%BC%8F"><span class="nav-number">9.3.</span> <span class="nav-text">LT模式和ET模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LT%E6%A8%A1%E5%BC%8F%E5%92%8CET%E6%A8%A1%E5%BC%8F%E5%A4%84%E7%90%86%E8%AF%BB%EF%BC%9A"><span class="nav-number">9.4.</span> <span class="nav-text">LT模式和ET模式处理读：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LT%E6%A8%A1%E5%BC%8F%E5%92%8CET%E6%A8%A1%E5%BC%8F%E5%A4%84%E7%90%86%E5%86%99"><span class="nav-number">9.5.</span> <span class="nav-text">LT模式和ET模式处理写</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">巨鹏辉</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
